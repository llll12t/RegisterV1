<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการสมาชิก | Member Management</title>
    <meta name="description" content="ระบบจัดการข้อมูลสมาชิก">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="Config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 rounded-full border-4 border-gray-200"></div>
                <div class="absolute inset-0 rounded-full border-4 border-black border-t-transparent animate-spin">
                </div>
            </div>
            <p class="text-gray-600 font-medium">กำลังโหลดข้อมูล...</p>
            <p class="text-gray-400 text-sm mt-1">กรุณารอสักครู่</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="min-h-screen p-4 sm:p-6">
        <div class="max-w-4xl mx-auto">

            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">จัดการสมาชิก</h1>
                        <p class="text-gray-500 mt-1">ดู แก้ไข หรือลบข้อมูลสมาชิกในระบบ</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="member-count" class="bg-black text-white px-4 py-2 rounded-xl text-sm font-semibold">
                            0 คน
                        </div>
                        <button onclick="fetchData()"
                            class="p-2.5 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition-colors"
                            title="รีเฟรช">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Table Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden animate-slide-up">
                <div class="overflow-x-auto">
                    <table id="data-table" class="w-full">
                        <thead>
                            <tr class="bg-gradient-to-r from-gray-900 to-gray-700">
                                <th
                                    class="px-6 py-4 text-center text-xs font-semibold text-white uppercase tracking-wider w-20">
                                    รูป</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">
                                    ชื่อ-สกุล</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider hidden sm:table-cell">
                                    รหัส</th>
                                <th
                                    class="px-6 py-4 text-center text-xs font-semibold text-white uppercase tracking-wider w-40">
                                    จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden py-16 text-center">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5"
                            viewBox="0 0 24 24">
                            <path
                                d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-500 font-medium">ยังไม่มีข้อมูลสมาชิก</p>
                    <p class="text-gray-400 text-sm mt-1">ข้อมูลจะแสดงที่นี่เมื่อมีการลงทะเบียน</p>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center items-center gap-2 mt-6 flex-wrap"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up">
            <div class="bg-gradient-to-r from-gray-900 to-gray-700 p-5">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">แก้ไขข้อมูล</h2>
                    <button onclick="closeModal()"
                        class="p-1.5 text-white/70 hover:text-white hover:bg-white/20 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="edit-form" class="p-5 space-y-4">
                <input type="hidden" id="edit-id">

                <!-- Image Preview -->
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <img id="edit-preview" src="" alt="Preview"
                        class="w-16 h-16 rounded-xl object-cover border-2 border-gray-200">
                    <div class="flex-1">
                        <label for="edit-image"
                            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-black rounded-lg cursor-pointer hover:bg-gray-800 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            เปลี่ยนรูป
                        </label>
                        <input type="file" id="edit-image" accept="image/*" class="hidden">
                        <input type="hidden" id="edit-imageUrl">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">LINE User ID</label>
                    <input type="text" id="edit-userID"
                        class="w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-gray-50 text-gray-500"
                        disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-สกุล</label>
                    <input type="text" id="edit-name"
                        class="w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-white text-gray-900 focus:outline-none focus:border-black focus:ring-2 focus:ring-black/5 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รหัสประจำตัว</label>
                    <input type="text" id="edit-employeeID"
                        class="w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-white text-gray-900 focus:outline-none focus:border-black focus:ring-2 focus:ring-black/5 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">แผนก</label>
                    <input type="text" id="edit-department"
                        class="w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-white text-gray-900 focus:outline-none focus:border-black focus:ring-2 focus:ring-black/5 transition-all">
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit" id="save-btn"
                        class="flex-1 px-4 py-3 text-sm font-semibold text-white bg-black rounded-xl hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M5 13l4 4L19 7" />
                        </svg>
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up">
            <div class="bg-gradient-to-r from-gray-900 to-gray-700 p-6 text-center">
                <button onclick="closeDetailModal()"
                    class="absolute top-4 right-4 p-1.5 text-white/70 hover:text-white hover:bg-white/20 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <img id="detail-image" src="" alt="Profile"
                    class="w-24 h-24 rounded-xl object-cover border-4 border-white/20 shadow-lg mx-auto mb-3">
                <h3 id="detail-name" class="text-xl font-bold text-white">-</h3>
            </div>
            <div class="p-5 space-y-4">
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-400">LINE User ID</p>
                        <p id="detail-userID" class="text-sm font-semibold text-gray-900 truncate">-</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path
                                d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-400">รหัสประจำตัว</p>
                        <p id="detail-employeeID" class="text-sm font-semibold text-gray-900 truncate">-</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-400">แผนก</p>
                        <p id="detail-department" class="text-sm font-semibold text-gray-900 truncate">-</p>
                    </div>
                </div>
            </div>
            <div class="p-5 pt-0">
                <button onclick="closeDetailModal()"
                    class="w-full px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">
                    ปิด
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const WEB_APP_URL = APP_CONFIG.WEB_APP_URL;
        const ROWS_PER_PAGE = 10;
        const PLACEHOLDER_IMG = 'https://placehold.co/100x100/f3f4f6/9ca3af?text=P';
        const ERROR_IMG = 'https://placehold.co/100x100/fee2e2/dc2626?text=!';

        let currentPage = 1;
        let tableData = [];

        // Utility Functions
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showSuccess(title, text) { return Swal.fire({ title, text, icon: 'success', confirmButtonText: 'ตกลง', confirmButtonColor: '#000000' }); }
        function showError(title, text) { return Swal.fire({ title, text, icon: 'error', confirmButtonText: 'ตกลง', confirmButtonColor: '#000000' }); }
        function showDeleteConfirm() { return Swal.fire({ title: 'ยืนยันการลบ', text: 'คุณแน่ใจหรือไม่ที่จะลบข้อมูลนี้?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก', confirmButtonColor: '#dc2626', cancelButtonColor: '#6b7280' }); }
        function getBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }

        // Fetch Data
        async function fetchData() {
            showLoading();
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                // Filter out header row and empty rows
                tableData = data.filter((row, index) => {
                    if (index === 0) return false; // Skip header
                    if (!row || !Array.isArray(row)) return false;
                    return row.some(cell => cell !== null && cell !== '');
                });

                document.getElementById('member-count').textContent = `${tableData.length} คน`;
                displayPage(currentPage);
                setupPagination();
            } catch (error) {
                console.error('Error:', error);
                showError('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลได้: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display Page
        function displayPage(page) {
            const startIndex = (page - 1) * ROWS_PER_PAGE;
            const paginatedData = tableData.slice(startIndex, startIndex + ROWS_PER_PAGE);
            const tableBody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');

            tableBody.innerHTML = '';

            if (tableData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            paginatedData.forEach(row => {
                if (!Array.isArray(row) || row.length < 6) return;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-4 text-center">
                        <img class="w-12 h-12 object-cover rounded-xl border-2 border-gray-100 shadow-sm mx-auto" 
                            src="${(row[5] && String(row[5]).trim()) ? row[5] : PLACEHOLDER_IMG}" 
                            alt="Profile" 
                            onerror="this.src='${ERROR_IMG}'">
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm font-semibold text-gray-900">${row[2] || 'N/A'}</p>
                        <p class="text-xs text-gray-400 mt-0.5 sm:hidden">${row[3] || ''}</p>
                    </td>
                    <td class="px-6 py-4 hidden sm:table-cell">
                        <p class="text-sm text-gray-600">${row[3] || '-'}</p>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick='openDetailModal(${JSON.stringify(row)})' class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="ดูข้อมูล">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                            <button onclick='openEditModal(${JSON.stringify(row)})' class="p-2 text-gray-500 hover:text-black hover:bg-gray-100 rounded-lg transition-colors" title="แก้ไข">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick='confirmDelete("${row[0]}")' class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="ลบ">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </td>`;
                tableBody.appendChild(tr);
            });
        }

        // Setup Pagination
        function setupPagination() {
            const pageCount = Math.ceil(tableData.length / ROWS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (pageCount <= 1) return;

            const createBtn = (content, disabled, active, onClick) => {
                const btn = document.createElement('button');
                btn.className = `min-w-10 h-10 flex items-center justify-center text-sm font-medium rounded-xl border-2 transition-all ${active ? 'border-black bg-black text-white shadow-lg' :
                        disabled ? 'border-gray-200 bg-white text-gray-300 cursor-not-allowed' :
                            'border-gray-200 bg-white text-gray-700 hover:border-black hover:bg-gray-50'
                    }`;
                btn.innerHTML = content;
                btn.disabled = disabled;
                if (onClick && !disabled) btn.onclick = onClick;
                return btn;
            };

            // Previous button
            pagination.appendChild(createBtn(
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>',
                currentPage === 1, false,
                () => { currentPage--; displayPage(currentPage); setupPagination(); }
            ));

            // Page numbers
            for (let i = 1; i <= pageCount; i++) {
                if (pageCount > 5) {
                    if (i === 1 || i === pageCount || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        pagination.appendChild(createBtn(i, false, i === currentPage, () => {
                            currentPage = i;
                            displayPage(currentPage);
                            setupPagination();
                        }));
                    } else if (i === 2 || i === pageCount - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'px-2 text-gray-400';
                        ellipsis.textContent = '...';
                        pagination.appendChild(ellipsis);
                    }
                } else {
                    pagination.appendChild(createBtn(i, false, i === currentPage, () => {
                        currentPage = i;
                        displayPage(currentPage);
                        setupPagination();
                    }));
                }
            }

            // Next button
            pagination.appendChild(createBtn(
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>',
                currentPage === pageCount, false,
                () => { currentPage++; displayPage(currentPage); setupPagination(); }
            ));
        }

        // Modal Functions
        function openEditModal(row) {
            document.getElementById('edit-id').value = row[0] || '';
            document.getElementById('edit-userID').value = row[1] || '';
            document.getElementById('edit-name').value = row[2] || '';
            document.getElementById('edit-employeeID').value = row[3] || '';
            document.getElementById('edit-department').value = row[4] || '';
            document.getElementById('edit-imageUrl').value = row[5] || '';
            document.getElementById('edit-preview').src = (row[5] && String(row[5]).trim()) ? row[5] : PLACEHOLDER_IMG;
            document.getElementById('edit-image').value = '';
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function openDetailModal(row) {
            document.getElementById('detail-image').src = (row[5] && String(row[5]).trim()) ? row[5] : PLACEHOLDER_IMG;
            document.getElementById('detail-name').textContent = row[2] || '-';
            document.getElementById('detail-userID').textContent = row[1] || '-';
            document.getElementById('detail-employeeID').textContent = row[3] || '-';
            document.getElementById('detail-department').textContent = row[4] || '-';
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // CRUD Operations
        async function updateData(id, userID, name, employeeID, department, imageData) {
            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

            try {
                const formData = new URLSearchParams();
                formData.append('method', 'updateData');
                formData.append('id', id);
                formData.append('userID', userID);
                formData.append('name', name);
                formData.append('employeeID', employeeID);
                formData.append('department', department);
                formData.append('imageUrl', imageData);

                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.text();

                if (result.toLowerCase().includes('updated') || result.toLowerCase().includes('success')) {
                    await showSuccess('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว');
                    closeModal();
                    await fetchData();
                } else {
                    throw new Error(result);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้');
            }
        }

        async function deleteData(id) {
            Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

            try {
                const formData = new URLSearchParams();
                formData.append('method', 'deleteData');
                formData.append('id', id);

                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.text();

                if (result.toLowerCase().includes('deleted') || result.toLowerCase().includes('success')) {
                    await showSuccess('สำเร็จ', 'ลบข้อมูลเรียบร้อยแล้ว');
                    if ((currentPage - 1) * ROWS_PER_PAGE >= tableData.length - 1 && currentPage > 1) {
                        currentPage--;
                    }
                    await fetchData();
                } else {
                    throw new Error(result);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้');
            }
        }

        function confirmDelete(id) {
            showDeleteConfirm().then(result => {
                if (result.isConfirmed) deleteData(id);
            });
        }

        // Form Submit
        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;
            const userID = document.getElementById('edit-userID').value;
            const name = document.getElementById('edit-name').value;
            const employeeID = document.getElementById('edit-employeeID').value;
            const department = document.getElementById('edit-department').value;
            const imageFile = document.getElementById('edit-image').files[0];
            let imageData = document.getElementById('edit-imageUrl').value;

            if (imageFile) {
                try {
                    imageData = await getBase64(imageFile);
                } catch (error) {
                    showError('เกิดข้อผิดพลาด', 'ไม่สามารถแปลงไฟล์รูปภาพได้');
                    return;
                }
            }

            await updateData(id, userID, name, employeeID, department, imageData);
        });

        // Preview Image
        document.getElementById('edit-image').addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('edit-preview').src = e.target.result;
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Initialize
        window.onload = fetchData;
    </script>
</body>

</html>